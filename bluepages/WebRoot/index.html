<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>BluePages</title>
<meta name="keywords" content="Search IBM employee information"/>
<meta name="description" content="Search for IBM employee globally"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="stylesheet" href="css/style.css"/>
<link rel="shortcut icon" href="ibm_16px.png"/>
</head>
<body>
<!-- Cover Page Container -->
<div class = "g-pagecontainer g-pagecontainer-cover">
	<h1>BluePages</h1>
	<!-- Click button jump to Search page -->
	<button autofocus><img alt="搜索图标" src="img/search.png"><span>Search BluePages</span></button>
</div>
<!-- Search page container -->
<div class = "g-pagecontainer g-pagecontainer-search hide">
	<!-- input frame and cancle button container-->
	<div class = "m-header">	
		<!-- onchange event to get data from server -->	
		<div class = "m-searchbar"><img alt="搜索图标" src="img/search.png"><input type="search" placeholder="Search BluePages..." autofocus="autofocus"/></div>
		<!-- Cancle: retrive to cover page -->		
		<button>Cancel</button>
	</div>
	<!-- recently viewed list and search result list container -->
	<div class = "m-main">
		<h2 class = "u-h2">recently viewed</h2>
		<ul class = "u-list"></ul>
	</div>
</div>
<div class = "g-pagecontainer g-pagecontainer-result hide">
	<div class = "m-header">
		<!-- Back: click button retrive to search page -->
		<button><img alt="back" src="img/Back.png"><p>Back</p></button>
		<!-- the input value is identical to the value in Search page container -->
		<div class = "m-searchbar"><img alt="搜索图标" src="img/search.png"><input type="search" autofocus="autofocus"/></div>
	</div>
	<!-- employee info container,generated by js using searching result data-->
	<div class = "m-main">
		<div class = "u-li">
			<img/>
			<p class = "u-p-name"></p>
			<p class = "u-p-position"></p>
			<p class = "u-p-department"></p>
		</div>
		<div class = "m-info m-info-mobile">
			<p class = "u-p-key">Mobile</p>
			<p class = "u-p-value">N/A</p>
		</div>
		<div class = "m-info m-info-work">
			<p class = "u-p-key">Work</p>
			<p class = "u-p-value">N/A</p>
		</div>
		<div class = "m-info m-info-email">
			<p class = "u-p-key">Email</p>
			<p class = "u-p-value">N/A</p>
		</div>
		<div class = "m-info m-info-notesID">
			<p class = "u-p-key">Notes ID</p>
			<p class = "u-p-value">N/A</p>
		</div>
		<div class = "m-info m-info-preferredContact">
			<p class = "u-p-key">Preferred Contact Method</p>
			<p class = "u-p-value">N/A</p>
		</div>
		<!-- <button class = "u-btn-wide u-btn-wide1"><span>Office location</span><img src="img/Forward.png"></button>
		<button class = "u-btn-wide u-btn-wide2"><span>Global team</span><img src="img/Forward.png"></button>
		<button class = "u-btn-wide u-btn-wide3"><span>Incountry team</span><img src="img/Forward.png"></button> -->
		
	</div>
</div>
<script type="text/javascript" src = "js/jquery-3.1.0.min.js"></script>
<script type="text/javascript">
var g_employeeInfo;//
var localStorage = window.localStorage;//browser local memory to store recently viewed data
var ajax_flag = true;
	/*global methods*/
var coverToSearch = function(){
    $(".g-pagecontainer-cover").toggleClass("hide");
  	$(".g-pagecontainer-search").toggleClass("hide");
  	$(".g-pagecontainer-search input")[0].focus();
}
var searchToCover = function(){
    $(".g-pagecontainer-cover").toggleClass("hide");
    $(".g-pagecontainer-search").toggleClass("hide");
}
var searchToResult = function(){
    $(".g-pagecontainer-result").toggleClass("hide");
  	$(".g-pagecontainer-search").toggleClass("hide");
}
var resultToSearch = function(){
    $(".g-pagecontainer-result").toggleClass("hide");
  	$(".g-pagecontainer-search").toggleClass("hide");
  	$(".g-pagecontainer-search input")[0].focus();
}
/*write items to localstorage*/
var localStorageSet = function(key,value){
    localStorage.setItem(key, value);
}
/*parse localstorage data to g_employeeInfo_local*/
function localStorageParse(){
    var array_empty = [];
    for(var i=0;i<localStorage.length;i++){
    	array_empty.unshift(JSON.parse( localStorage.getItem(localStorage.key(i))));
    }
    return array_empty;
}
/*search result generate method*/
function createList(data){   				
    if(data.length){    					
    	$.each(data,function(index,value){
			var li = $("<li />",{"class":"u-li"});    				
    	    var img = $("<img />",{"alt" : "Favicon"}); 
    	    var p_Name = $("<p />");
    	    var p_Title = $("<p />");
    	    var p_Region = $("<p />");
    		img.attr("src",value.imgURL);
    		p_Name.html(value.name);
    		p_Title.html(value.position);
    		p_Region.html(value.region);
    		li.append(img).append(p_Name).append(p_Title).append(p_Region);
    		$(".g-pagecontainer-search .u-list").append(li);
    	});    					
    }
}
/*flush search result method*/
var flushList = function(){
    $(".g-pagecontainer-search .u-list").children().remove();
}
/*updata employeeInfo result*/
var restructResult = function(index){
    $(".g-pagecontainer-result .u-li img").attr("src", g_employeeInfo[index].imgURL);
  	$(".g-pagecontainer-result .u-li .u-p-name").html(g_employeeInfo[index].name).css({"font-size":"100%","color":"black"});
  	$(".g-pagecontainer-result .u-li .u-p-position").html(g_employeeInfo[index].position);
  	$(".g-pagecontainer-result .u-li .u-p-department").html(g_employeeInfo[index].department);
  	$(".g-pagecontainer-result .m-info-mobile .u-p-value").html(g_employeeInfo[index].mobile);
  	$(".g-pagecontainer-result .m-info-work .u-p-value").html(g_employeeInfo[index].work);
  	$(".g-pagecontainer-result .m-info-email .u-p-value").html(g_employeeInfo[index].email);
  	$(".g-pagecontainer-result .m-info-notesID .u-p-value").html(g_employeeInfo[index].notes_ID);
  	$(".g-pagecontainer-result .m-info-preferredContact .u-p-value").html(g_employeeInfo[index].preferred_Contact_Method);
/*check the local storage elements,if the clicked element already exist,update it!*/
  	for(var i=0;i<localStorage.length;i++){
    	if(JSON.parse( localStorage.getItem(localStorage.key(i))).name == g_employeeInfo[index].name)
    	{ 
    		localStorage.removeItem(localStorage.key(i));
    		localStorageSet(new Date(), JSON.stringify(g_employeeInfo[index]));
    		return;
    	};
    }
/*if the localstorage is 'full',update the list.*/
    if(localStorage.length == 10){
    	localStorage.removeItem(localStorage.key(0));
    }
/*save the clicked element to the localstorage*/
  	localStorageSet(new Date(), JSON.stringify(g_employeeInfo[index]));
}
function initListLocal(){
	$(".g-pagecontainer-search .u-h2").text("recently viewed");
    g_employeeInfo = localStorageParse();//store the employee data from local storage
	createList(g_employeeInfo);
} 
$(function() {
	/*load the localstorage data and generate history list*/
    initListLocal();
    /*jump to the search page*/
  	$(".g-pagecontainer-cover button").on("click",function(e){ coverToSearch();});
  	/*back to the coverpage*/
	$(".g-pagecontainer-search button").on("click",function(e){	
		searchToCover();
		$(".g-pagecontainer-search input").val("");
		flushList();
		initListLocal();
	});
	/*back to the searchpage*/
	$(".g-pagecontainer-result .m-header").on("click",function(e){ resultToSearch();}); 

	/*capture search input and send "GET" request to server,finally generate the result list.*/
  	$(".g-pagecontainer-search input").on("input propertychange",function(e){
  		/*store the input value*/
  		var inputValue = $(this).val();
  		/*fill the result page input value*/
  		$(".g-pagecontainer-result .m-searchbar input").val(inputValue);
  		/*flush the search result list*/
  		flushList();
 		/*the length of input value is not too short*/
        if(inputValue.length > 1){
        	if(ajax_flag == true){
        		ajax_flag = false;
        		$.ajax({
      			async:true,
    			url:'/bluepageDB',
    			type:'get',
    			data:{name:inputValue},
    			dataType:'json',
    			timeout:30000,
    			success:function(data){
    				ajax_flag = true;
    				g_employeeInfo = data;
    				$(".g-pagecontainer-search .u-h2").text("Found " + data.length + " matches"); 
    				createList(g_employeeInfo);
    			},								
    			error:function(){
    				console.log("error");
    			}
      		});  
        	}   
        	else {return;}     		
        }
        else{//generate the search result list from localstorage        		
        		initListLocal();
        	} 			
  	});
  	/*click the search result list,jump to result page*/
  	$(".g-pagecontainer-search .u-list").delegate("li","click",function(e){  		
  		var index = $(".g-pagecontainer-search .u-list li").index(this);
  		restructResult(index);
		searchToResult();
  	});
});
</script>
</body>
</html>
